<link rel="import" href="../polymer/polymer.html"/>

<link rel="import" href="../px-vis/px-vis-behavior-common.html" />
<link rel="import" href="../px-vis/px-vis-behavior-d3.html" />
<link rel="import" href="../px-vis/px-vis-behavior-chart.html" />
<link rel="import" href="../px-vis/px-vis-behavior-scale.html" />
<link rel="import" href="../px-vis/px-vis-svg.html"/>
<link rel="import" href="../px-vis/px-vis-line-svg.html"/>
<link rel="import" href="../px-vis/px-vis-axis.html"/>
<link rel="import" href="../px-vis/px-vis-gridlines.html"/>
<link rel="import" href="../px-vis/px-vis-interaction-space.html"/>
<link rel="import" href="../px-vis/px-vis-cursor.html"/>
<link rel="import" href="../px-vis/px-vis-tooltip.html"/>
<link rel="import" href="../px-vis/px-vis-register.html"/>
<link rel="import" href="../px-vis/px-vis-threshold.html"/>
<link rel="import" href="../px-vis/px-vis-clip-path.html"/>
<link rel="import" href="../px-vis/px-vis-toolbar.html"/>
<link rel="import" href="../px-vis/px-vis-annotations.html"/>
<link rel="import" href="../px-vis/px-vis-bar-svg.html"/>
<link rel="import" href="../px-vis/px-vis-bar-grouped-svg.html"/>

<link rel="import" href="css/px-vis-bar-chart-styles.html">

<!--
REPLACE THIS TEXT WITH A COMPONENT DESCRIPTION

No

### Usage

    <px-vis-bar-chart counter-value="1"></px-vis-bar-chart>

@element px-vis-bar-chart
@blurb REPLACE THIS TEXT WITH A COMPONENT DESCRIPTION
@homepage index.html
@demo index.html
-->

<dom-module id="px-vis-bar-chart">
  <template>
    <style include="px-vis-bar-chart-styles"></style>

    <div id="wrapper" class$="{{_chartWrapperClass}}" >
      <!--[chart + navigator] + register-->
      <div class$="{{_registerWrapperClass}} safari-flex-fix">
        <px-vis-register
          id="register"
          dynamic-menu-config="[[dynamicMenuConfig]]"
          chart-width="[[width]]"
          height="[[_verticalRegisterHeight]]"
          margin="[[margin]]"
          class$="{{_getHideClass(hideRegister)}}"
          units="[[units]]"
          tooltip-data="[[tooltipData]]"
          chart-data="[[chartData]]"
          complete-series-config="[[completeSeriesConfig]]"
          muted-series="{{mutedSeries}}"
          type="{{_registerType}}"
          x-axis-type="[[xAxisType]]"
          y-axis-type="[[yAxisType]]"
          inert-register="[[hideRegister]]"
          current-page="[[_registerCurrentPage]]"
          total-pages="[[_registerTotalPages]]"
          display-page-arrows="[[_registerDisplayPageArrows]]"
          reverse-display-order="[[_getRegisterDisplayOrder(yAxisType)]]">
        </px-vis-register>

        <!-- chart + navigator -->
        <div id="drawingWrapper" class="flex--col flex__item--no-grow inline--flex">
          <px-vis-toolbar
            id="toolbar"
            current-sub-config='[[toolbarSubConfig]]'
            action-config='{{actionConfig}}'
            within-chart
            chart-margin="[[margin]]"
            config='{"zoom": true, "pan": true, "tooltip": true}'>
          </px-vis-toolbar>
          <px-vis-svg
            id="svgCanvas"
            class="flex__item--no-grow"
            width="[[width]]"
            height="[[height]]"
            margin="[[margin]]"
            svg="{{svg}}"
            px-svg-elem="{{pxSvgElem}}">
              <px-vis-annotations
                slot="4"
                svg="[[svg]]"
                x="[[x]]"
                y="[[y]]"
                margin="[[margin]]"
                domain-changed="[[domainChanged]]"
                complete-series-config="[[completeSeriesConfig]]"
                annotation-data="[[annotationData]]"
                show-strong-icon="[[showStrongIcon]]">
              </px-vis-annotations>
          </px-vis-svg>
        </div>
      </div>
    </div>

    <px-vis-tooltip
      id="tooltip"
      hover-target=[[mouseRect]]
      mouse-position="[[mousePosition]]"
      width="250"
      margin="[[margin]]"
      chart-data="[[chartData]]"
      tooltip-data="[[tooltipData]]"
      complete-series-config="[[completeSeriesConfig]]"
      x-axis-type="[[xAxisType]]"
      y-axis-type="[[yAxisType]]"
      tooltip-style="light"
      muted-series="[[mutedSeries]]"
      hide="[[!_computedShowTooltip]]"
      series-keys="[[_seriesKeys]]">
    </px-vis-tooltip>

    <px-vis-clip-path
      svg="[[layer.2]]"
      width="[[width]]"
      height="[[height]]"
      margin="[[margin]]"
      clip-path="{{clipPath}}"
      series-clip-path="{{seriesClipPath}}">
    </px-vis-clip-path>

    <template is="dom-if" if="[[!grouped]]">
      <template is="dom-repeat" items="[[_stackedChartData]]">
        <px-vis-bar-svg
          id="bars"
          svg="[[layer.2]]"
          complete-series-config="[[completeSeriesConfig]]"
          chart-data="[[item]]"
          series-key="[[item.key]]"
          x="[[x]]"
          y="[[y]]"
          type="[[chartType]]"
          domain-changed="[[domainChanged]]"
          clip-path="[[seriesClipPath]]"
          highlight-bar="[[_getOrdSet(tooltipData.*)]]">
        </px-vis-bar-svg>
      </template>
    </template>

    <template is="dom-if" if="[[grouped]]">
      <px-vis-bar-grouped-svg
        id="bars"
        svg="[[layer.2]]"
        height="[[height]]"
        margin="[[margin]]"
        complete-series-config="[[completeSeriesConfig]]"
        chart-data="[[chartData]]"
        x="[[x]]"
        y="[[y]]"
        ordinal-key="[[_ordinalKey]]"
        group-scale="[[_groupScale]]"
        series-keys="[[_seriesKeys]]"
        type="[[chartType]]"
        domain-changed="[[domainChanged]]"
        clip-path="[[seriesClipPath]]"
        highlight-bar="[[_getOrdSet(tooltipData.*)]]">
      </px-vis-bar-grouped-svg>
    </template>

    <!-- <template id="lineTemplate" is="dom-repeat" items="[[_seriesKeys]]">
      <template is="dom-if" if="[[_chartTypeLine(item,completeSeriesConfig)]]" restamp>
          <px-vis-line-svg
            id="lineSVG"
            svg="[[layer.1]]"
            series-id="[[item]]"
            chart-data="[[chartData]]"
            complete-series-config="[[completeSeriesConfig]]"
            domain-changed="[[domainChanged]]"
            x="[[x]]"
            y="[[_returnYScale(item, completeSeriesConfig, domainChanged)]]"
            show-gaps="[[showGaps]]"
            clip-path="[[seriesClipPath]]"
            muted-series="[[mutedSeries]]"
            stroke-width="[[_returnStrokeWidth(item, completeSeriesConfig)]]"
            interpolation-function="[[interpolationFunction]]"
            serie-to-redraw-on-top="[[serieToRedrawOnTop]]">
          </px-vis-line-svg>
      </template>
    </template> -->

    <px-vis-threshold
      svg="[[layer.3]]"
      complete-series-config="[[completeSeriesConfig]]"
      threshold-data="[[thresholdData]]"
      threshold-config="[[thresholdConfig]]"
      width="[[width]]"
      margin="[[margin]]"
      y="[[y]]"
      domain-changed="[[domainChanged]]"
      clip-path="[[seriesClipPath]]"
      show-threshold-box="[[showThresholdBox]]"
      language="[[language]]">
    </px-vis-threshold>

    <px-vis-axis
      id="xAxis"
      svg="[[layer.1]]"
      domain-changed="[[domainChanged]]"
      axis="[[x]]"
      axis-type="[[xAxisType]]"
      margin="[[margin]]"
      width="[[width]]"
      height="[[height]]"
      orientation="[[xAxisLocation]]"
      label-position="after"
      complete-series-config="[[completeSeriesConfig]]"
      prevent-series-bar>
    </px-vis-axis>
    <px-vis-axis
      id="yAxis"
      svg="[[layer.1]]"
      domain-changed="[[domainChanged]]"
      axis="[[y]]"
      axis-type="[[yAxisType]]"
      margin="[[margin]]"
      width="[[width]]"
      height="[[height]]"
      orientation="[[yAxisLocation]]"
      label-position="after"
      complete-series-config="[[completeSeriesConfig]]"
      prevent-series-bar>
    </px-vis-axis>

    <template is="dom-if" if="[[_showGridlines(hideGridlines, chartType, 'bar')]]" restamp>
      <px-vis-gridlines
        svg="[[layer.0]]"
        axis="[[x]]"
        margin="[[margin]]"
        length="[[height]]"
        orientation="bottom"
        domain-changed="[[domainChanged]]">
      </px-vis-gridlines>
    </template>
    <template is="dom-if" if="[[_showGridlines(hideGridlines, chartType, 'column')]]" restamp>
      <px-vis-gridlines
        svg="[[layer.0]]"
        axis="[[y]]"
        margin="[[margin]]"
        length="[[width]]"
        orientation="left"
        domain-changed="[[domainChanged]]">
      </px-vis-gridlines>
    </template>

    <px-vis-interaction-space
      id="interactionSpace"
      svg="[[layer.4]]"
      width="[[width]]"
      height="[[height]]"
      margin="[[margin]]"
      x-axis-type="[[xAxisType]]"
      y-axis-type="[[yAxisType]]"
      series-keys="[[_seriesKeys]]"
      complete-series-config="[[completeSeriesConfig]]"
      chart-data="[[chartData]]"
      chart-id="[[chartId]]"
      x="[[x]]"
      y="[[y]]"
      domain-changed="[[domainChanged]]"
      mouse-rect="{{mouseRect}}"
      tooltip-data="{{tooltipData}}"
      crosshair-data="{{crosshairData}}"
      default-empty-data="[[defaultEmptyData]]"
      generating-crosshair-data="{{generatingCrosshairData}}"
      interaction-svg="{{interactionSvg}}"
      extents-data="{{extentsData}}"
      action-config="[[actionConfig]]"
      selection-type="[[selectionType]]"
      extents-action="{{extentsAction}}"
      muted-series="[[mutedSeries]]"
      hard-mute="[[hardMute]]"
      is-bar
      prevent-web-worker-synchronization="[[preventWebWorkerSynchronization]]"
      ww-data-sync-counter="[[wwDataSyncCounter]]">
    </px-vis-interaction-space>

    <px-vis-cursor
      id="cursor"
      svg="[[layer.3]]"
      width="[[width]]"
      height="[[height]]"
      margin="[[margin]]"
      complete-series-config="[[completeSeriesConfig]]"
      chart-data="[[chartData]]"
      tooltip-data="[[_registerTooltipData]]"
      clip-path="[[seriesClipPath]]"
      muted-series="[[mutedSeries]]"
      hard-mute="[[hardMute]]"
      series-keys="[[_seriesKeys]]">
    </px-vis-cursor>

  </template>
  <script>
    const behaviours = [
    PxVisBehavior.observerCheck,
    PxVisBehavior.baseSize,
    PxVisBehavior.margins,
    PxVisBehavior.dataset,
    PxVisBehavior.completeSeriesConfig,
    PxVisBehavior.muteUnmuteSeries,
    PxVisBehavior.tooltipData,
    PxVisBehavior.extentsData,
    PxVisBehavior.commonMethods,
    PxVisBehavior.zoomSelection,
    PxVisBehavior.chartExtents,
    PxVisBehavior.dataExtents,
    PxVisBehavior.events,
    PxVisBehaviorD3.svg,
    PxVisBehaviorD3.svgLower,
    PxVisBehaviorD3.axes,
    PxVisBehaviorD3.clipPath,
    PxVisBehaviorChart.chartCommon,
    PxVisBehaviorChart.saveImage,
    PxVisBehaviorD3.domainUpdate,
    PxVisBehaviorChart.subConfiguration,
    PxVisBehaviorChart.registerConfigs,
    PxVisBehaviorChart.axisConfigs,
    PxVisBehaviorChart.registerPositioning,
    PxVisBehaviorChart.chartAutoResize,
    PxVisBehavior.thresholds,
    PxVisBehaviorChart.layers,
    PxVisBehaviorChart.navigatorConfig,
    PxVisBehavior.dynamicMenuConfig,
    PxColorsBehavior.dataVisColorTheming,
    PxVisBehavior.axisTypes,
    PxVisBehaviorScale.scale,
    PxVisBehavior.actionConfig,
    PxVisBehaviorChart.zooming,
    PxVisBehaviorChart.actionRequest,
    PxVisBehaviorChart.toolbarSubConfig,
    PxVisBehaviorChart.noDebounceOnPanning,
    PxVisBehaviorChart.chartToolbarConfig,
    PxVisBehaviorChart.showTooltip,
    // PxVisBehaviorChart.sizeVerticalRegister,
    PxVisBehaviorChart.thresholdConfig,
    PxVisBehavior.selectionType,
    PxVisBehaviorChart.webWorkerSynchronization,
    // Polymer.AppLocalizeBehavior,
    PxVisBehavior.updateStylesOverride,
    PxVisBehavior.annotationData,
    PxVisBehaviorChart.cursorConfig,
    PxVisBehaviorChart.registerPagnation,
    PxVisBehaviorChart.tooltipSizing
  ];

  class PxVisBarChart extends Polymer.mixinBehaviors(behaviours, Polymer.Element) {
    static get is() { return 'px-vis-bar-chart'; }

    static get properties() {
      return {
        preventWebWorkerSynchronization: {
          type: Boolean,
          value: true,
          readOnly: true
        },
        /**
        * Specfies what type of bar chart:
        * - `bar`
        * - `horizontal`
        */
        chartType: {
          type: String,
          value: 'column'
        },

        _stackedChartData: {
          type: Array,
          computed: '_returnStack(chartData.*, _seriesKeys.*)'
        },

        /**
         * Defines where to locate the X-axis.
         * - `bottom`
         * - `top`
         *
         */
        xAxisLocation: {
          type:String,
          value:'bottom'
        },
        /**
         * Defines where to locate the Y-axis.
         * - `left`
         * - `right`
         *
         */
        yAxisLocation: {
          type: String,
          value:'left'
        },

        /**
         * DO NOT CHANGE THIS UNLESS YOU KNOW WHAT YOU ARE DOING
         *
         * Bar charts in nearly all cases should start from 0. If you have a special case and understand the ramifications, change this to false to allow it to use the `min` value from your data
         */
        startFromZero: {
          type: Boolean,
          value: true
        },

        _ordinalKey: {
          type: String,
          computed: '_getOrdKey(completeSeriesConfig.*)'
        },

        _stackedDataExtentsTrigger: {
          type: Number,
          value: 0
        },

        grouped: {
          type: Boolean,
          value: false
        }

      };
    }

    static get observers() {
      return [
        '_setAxisTypes(chartType)',
        '_setXScale(width, margin, xAxisType)',
        '_setYScale(height, margin, yAxisType)',
        '_setDomain(_chartDataHasChanged, x, y, completeSeriesConfig, _stackedDataExtentsTrigger)',
        '_setDomain(chartExtents, _stackedDataExtentsTrigger)',
        '_updateDomain(selectedDomain)',
        '_chartDataChanged(chartData.*)',
        '_calcTooltipPos(tooltipData.*)',
        '_calcStackedDataExt(_stackedChartData, completeSeriesConfig, grouped)',
        '_createGroupScale(x,y, completeSeriesConfig, grouped)'
      ];
    }

    ready() {
      super.ready();
      this.set('numberOfLayers', 5);
    }

    connectedCallback() {
      super.connectedCallback();
    }

    _returnStack() {
      if(this.grouped) {
        return [];
      }

      if(this.chartData && this._seriesKeys && this.completeSeriesConfig) {
        const axis = this.xAxisType === 'scaleBand' ? 'y' : 'x';
        let stack = Px.d3.stack();
        let keys = [];

        this._seriesKeys.forEach((k) => {
          keys.push(this.completeSeriesConfig[k][axis]);
        });

        stack.keys(keys);
        return stack(this.chartData);
      }
    }

    _setAxisTypes(chartType) {
      switch(chartType) {
        case 'bar':
          this.set('xAxisType', "linear");
          this.set('yAxisType', "scaleBand");
          break;

        default:  //column
          this.set('xAxisType', "scaleBand");
          this.set('yAxisType', "linear");
          break;
      }
    }

    _getOrdKey() {
      if(this.hasUndefinedArguments(arguments)) {
        return;
      }

      if(this._seriesKeys && this._seriesKeys.length) {
        const k = this.xAxisType === 'scaleBand' ? 'x' : 'y';
        return this.completeSeriesConfig[this._seriesKeys[0]][k];
      } else {
        return '';
      }
    }

    _getRegisterDisplayOrder(yAxisType) {
      return yAxisType === 'scaleBand'
    }

    _showGridlines(hideGridlines, chartType, type) {
      if(chartType === type && !hideGridlines) {
        return true;
      }

      return false;
    }

    _calcTooltipPos() {
      if(this.showTooltip && this.tooltipData && this.tooltipData.series && this.tooltipData.series.length && this.tooltipData.series[0].coord) {
        if(!this._svgClientRect) {
          this._getImmediateSizing();
        }

        //calc the screen positions for the tooltip
        var screenX = this.tooltipData.series[0]['coord'][0] + this._svgClientRect.left + this._winX + 15,
            screenY = this.tooltipData.series[0]['coord'][1] + this.margin.top + this._svgClientRect.top + this._winY;

        this.set('mousePosition', [screenX, screenY]);
      }
    }

    _getOrdSet() {
      if(this.tooltipData && this.tooltipData.ordinalSet) {
        return this.tooltipData.ordinalSet;
      }

      return '';
    }

    _calcStackedDataExt() {
      if(this.grouped) {
        this.set('_stackedDataExtentsTrigger', this._stackedDataExtentsTrigger += 1);
      }

      if(this.completeSeriesConfig && this._doesObjHaveValues(this._stackedChartData)) {
        const min = Px.d3.min(this._stackedChartData, (dataset) => {
          return Px.d3.min(dataset, (d) => { return d[0]; });
        });
        const max = Px.d3.max(this._stackedChartData, (dataset) => {
          return Px.d3.max(dataset, (d) => { return d[1]; });
        });

        if(this.xAxisType === 'scaleBand') {
          this.dataExtents = {
            "x": this.dataExtents.x,
            "y": [min,max]
          };
        } else {
          this.dataExtents = {
            "x": [min,max],
            "y": this.dataExtents.y
          };
        }

        this.set('_stackedDataExtentsTrigger', this._stackedDataExtentsTrigger += 1);
      }
    }

    _createGroupScale() {
      if(!this.grouped || !this.x || !this.y || !this.completeSeriesConfig) {
        return;
      }

      const ordScale = this.xAxisType === 'scaleBand' ? 'x' : 'y';
      const valScale = this.xAxisType === 'scaleBand' ? 'y' : 'x';
      let keys = [];

      this._seriesKeys.forEach((k) => {
        keys.push(this.completeSeriesConfig[k][valScale]);
      });

      let scale = Px.d3.scaleBand()
        .padding(0.05)
        .rangeRound([0, this[ordScale].bandwidth()])
        .domain(keys);

      this.set('_groupScale', scale);
    }

  }

  window.customElements.define(PxVisBarChart.is, PxVisBarChart);
  </script>
</dom-module>